// music beats' timestamps
// 1 Godfrey Meyer - Bring Me Up.mp3
var beats = [0.580498866213,1.09133786848,1.5789569161,2.06657596372,2.55419501134,3.04181405896,3.52943310658,3.99383219955,4.45823129252,4.89941043084,5.36380952381,5.82820861678,6.29260770975,6.75700680272,7.26784580499,7.75546485261,8.26630385488,8.75392290249,9.26476190476,9.77560090703,10.2632199546,10.7276190476,11.2152380952,11.7028571429,12.1904761905,12.6780952381,13.1657142857,13.6533333333,14.1177324263,14.5821315193,15.0465306122,15.5109297052,15.9753287982,16.4861678005,16.9737868481,17.4846258503,17.972244898,18.4830839002,18.9707029478,19.4583219955,19.9691609977,20.4567800454,20.9676190476,21.4552380952,21.9660770975,22.4536961451,22.9413151927,23.452154195,23.9397732426,24.4273922902,24.9382312925,25.4258503401,25.9366893424,26.42430839,26.9351473923,27.4227664399,27.9336054422,28.4212244898,28.9088435374,29.4196825397,29.9073015873,30.4181405896,30.9057596372,31.3933786848,31.9042176871,32.3918367347,32.902675737,33.3902947846,33.9011337868,34.3887528345,34.8995918367,35.3872108844,35.874829932,36.3856689342,36.8732879819,37.3841269841,37.8717460317,38.3593650794,38.8702040816,39.3578231293,39.8686621315,40.3562811791,40.8439002268,41.354739229,41.8655782313,42.3531972789,42.8408163265,43.3516553288,43.8392743764,44.326893424,44.8145124717,45.3021315193,45.7897505669,46.3005895692,46.8114285714,47.3222675737,47.833106576,48.3207256236,48.8083446712,49.3191836735,49.8068027211,50.3176417234,50.805260771,51.3160997732,51.8037188209,52.2913378685,52.8021768707,53.2897959184,53.8006349206,54.2882539683,54.7990929705,55.2867120181,55.7975510204,56.285170068,56.7727891156,57.2836281179,57.7712471655,58.2588662132,58.7697052154,59.257324263,59.7681632653,60.2557823129,60.7666213152,61.2542403628,61.7650793651,62.2526984127,62.7403174603,63.2279365079,63.7387755102,64.2496145125,64.7372335601,65.2248526077,65.73569161,66.2233106576,66.7341496599,67.2217687075,67.7326077098,68.2202267574,68.7310657596,69.2186848073,69.7063038549,70.2171428571,70.7047619048,71.215600907,71.7032199546,72.1908390023,72.7016780045,73.1892970522,73.7001360544,74.187755102,74.6985941043,75.1862131519,75.6738321995,76.1614512472,76.6490702948,77.1599092971,77.6475283447,78.1583673469,78.6692063492,79.1568253968,79.6676643991,80.1552834467,80.666122449,81.1537414966,81.6645804989,82.1521995465,82.6630385488,83.1506575964,83.638276644,84.1491156463,84.6367346939,85.1475736961,85.6351927438,86.1228117914,86.6336507937,87.1212698413,87.6321088435,88.1197278912,88.6305668934,89.118185941,89.6058049887,90.1166439909,90.6042630385,91.1151020408,91.6027210884,92.0903401361,92.6011791383,93.0887981859,93.5996371882,94.0872562358,94.5980952381,95.0857142857,95.5733333333,96.0841723356,96.5717913832,97.0826303855,97.5702494331,98.0810884354,98.568707483,99.0795464853,99.5671655329,100.05478458,100.565623583,101.05324263,101.564081633,102.05170068,102.562539683,103.05015873,103.537777778,104.04861678,104.536235828,105.023854875,105.534693878,106.022312925,106.533151927,107.020770975,107.531609977,108.019229025,108.506848073,109.017687075,109.528526077,110.016145125,110.503764172,111.014603175,111.502222222,111.98984127,112.500680272,112.98829932,113.499138322,113.98675737,114.497596372,114.98521542,115.496054422,115.983673469,116.471292517,116.982131519,117.469750567,117.980589569,118.468208617,118.979047619,119.466666667,119.954285714,120.465124717,120.952743764,121.463582766,121.951201814,122.462040816,122.949659864,123.437278912,123.948117914,124.435736961,124.923356009,125.434195011,125.921814059,126.432653061,126.920272109,127.431111111,127.918730159,128.406349206,128.917188209,129.428027211,129.915646259,130.403265306,130.914104308,131.401723356,131.912562358,132.400181406,132.887800454,133.398639456,133.886258503,134.397097506,134.884716553,135.395555556,135.883174603,136.394013605,136.881632653,137.369251701,137.880090703,138.367709751,138.878548753,139.3661678,139.853786848,140.36462585,140.852244898,141.3630839,141.850702948,142.338321995,142.825941043,143.336780045,143.847619048,144.335238095,144.846077098,145.333696145,145.844535147,146.332154195,146.819773243,147.330612245,147.818231293,148.329070295,148.816689342,149.327528345,149.815147392,150.325986395,150.813605442,151.30122449,151.812063492,152.29968254,152.810521542,153.29814059,153.785759637,154.296598639,154.784217687,155.295056689,155.782675737,156.270294785,156.757913832,157.24553288,157.756371882,158.267210884,158.754829932,159.265668934,159.753287982,160.264126984,160.751746032,161.262585034,161.750204082,162.261043084,162.748662132,163.259501134,163.747120181,164.234739229,164.745578231,165.233197279,165.744036281,166.231655329,166.719274376,167.230113379,167.717732426,168.228571429,168.716190476,169.227029478,169.714648526,170.202267574,170.713106576,171.200725624,171.711564626,172.199183673,172.710022676,173.197641723,173.685260771,174.196099773,174.683718821,175.171337868,175.682176871,176.169795918,176.680634921,177.191473923,177.679092971,178.166712018,178.67755102,179.165170068,179.652789116,180.163628118,180.651247166,181.162086168,181.649705215,182.160544218,182.648163265,183.135782313,183.646621315,184.134240363,184.62185941,185.132698413,185.643537415,186.131156463,186.61877551,187.129614512,187.61723356,188.128072562,188.61569161,189.126530612,189.61414966,190.124988662,190.61260771,191.100226757,191.587845805,192.098684807,192.586303855,193.097142857,193.584761905,194.095600907,194.583219955,195.094058957,195.581678005,196.092517007,196.580136054,197.067755102,197.578594104,198.066213152,198.577052154,199.064671202,199.552290249,200.063129252,200.550748299,201.061587302,201.549206349,202.060045351,202.547664399,203.058503401,203.546122449,204.033741497,204.544580499,205.032199546,205.543038549,206.030657596];
var isJanusWeb = typeof(elation) !== 'undefined';
var beat_index = 0;
var beat_fade = 0.0;
var playing = false;
var current_time = 0.0;
var speaker_base_scale = {};
var speaker_ids = ['speaker_base_1', 'speaker_1', 'speaker_base_2', 'speaker_2', 'speaker_base_3', 'speaker_3'];
room.update = function(dt) {
	if (isJanusWeb) {
		if (room.pendingassets.length == 0 && room.sounds['music'].audio.isPlaying == false) {
			for (var index in speaker_ids) {
				var speaker = speaker_ids[index];
				speaker_base_scale[speaker] = V(room.objects[speaker].scale);
			}
			room.sounds['music'].audio.setLoop(false);
			room.playSound('music');
			current_time = 0.0;
			beat_index = 0;
			return;
		}
	}
	if (room.sounds['music'].audio.isPlaying == true) {
		current_time += dt * 0.001;
	}
	if (beat_index >= 0) {
		while (current_time >= beats[beat_index]) {
			beat_fade = 1.0;
			if (beats.length > beat_index) {
				beat_index += 1;
			} else {
				// loop here
				current_time = 0;
				beat_index = -1;
			}
		}
	}
	if (beat_fade > 0) {
		beat_fade = Math.max(0, beat_fade - dt * 0.001 * 10);
		for (var index in speaker_ids) {
			var speaker = speaker_ids[index];
			room.objects[speaker].scale = scalarMultiply(speaker_base_scale[speaker], 1.0+beat_fade*0.25);
		}
		
	}
}